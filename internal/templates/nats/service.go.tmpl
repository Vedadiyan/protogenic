package {{ .ImportPath }}

import (
	"time"

	helpers "github.com/vedadiyan/goal-helpers/pkg"
	"github.com/vedadiyan/goal/pkg/http"
	"github.com/vedadiyan/goal/pkg/service"
	"google.golang.org/protobuf/proto"
)

const (
	_CN_{{ .MethodName | ToUpperCase }}          = "{{ .ConnName }}"
	_NS_{{ .MethodName | ToUpperCase }}          = "{{ .Namespace }}"
	_AUTH_SVC_{{ .MethodName | ToUpperCase }}   = "{{ .AuthService }}"
	_AUTH_SVC_CI_{{ .MethodName | ToUpperCase }} = {{ .AuthServiceCacheInterval }}
	_QUEUE_{{ .MethodName | ToUpperCase }}      = "{{ .Queue }}"
	_URL_{{ .MethodName | ToUpperCase }}         = "{{ .Url }}"
	_METHOD_{{ .MethodName | ToUpperCase }}    = "{{ .Method }}"
)

var (
	_url{{ .MethodName | ToPascalCase }}       *http.UrlTemplate
	_reqMapper{{ .MethodName | ToPascalCase }} []byte
	_resMapper{{ .MethodName | ToPascalCase }} []byte
)

type (
	Request{{ .MethodName | ToPascalCase }}  = {{ .RequestType }}
	Response{{ .MethodName | ToPascalCase }} = {{ .ResponseType}}
)

func handler{{ .MethodName | ToPascalCase}}(m *Request{{ .MethodName | ToPascalCase }}) (*Response{{ .MethodName | ToPascalCase }}, error) {
	req, err := helpers.ToJSONReq(m, _reqMapper{{ .MethodName | ToPascalCase }})
	if err != nil {
		return nil, err
	}
	url, err := _url{{ .MethodName | ToPascalCase }}.Url(req.RouteValues, req.QueryParams)
	if err != nil {
		return nil, err
	}
	webHeaders, err := getWHC{{ .MethodName | ToPascalCase }}()
	if err != nil {
		return nil, err
	}
	res, err := http.Send(url, webHeaders, _METHOD_{{ .MethodName | ToUpperCase }} , req.Body)
	if err != nil {
		return nil, err
	}
	var response Response{{ .MethodName | ToPascalCase }}
	err = helpers.FromJSONRes(res.Reader(), _resMapper{{ .MethodName | ToPascalCase }}, &response)
	if err != nil {
		return nil, err
	}
	return &response, nil
}

func getWHC{{ .MethodName | ToPascalCase }}() (http.IWebHeaderCollection, error) {
	whc := http.NewWebHeaderCollection()
	{{- range $key, $value := .WebHeaderCollection }}
    whc.Add("{{ $key }}", "{{ $value }}")
    {{- end }}
	if _AUTH_SVC_{{ .MethodName | ToUpperCase }}!= "" {
		webHeaders, err :=
			helpers.GetAuthHeaders(_CN_{{ .MethodName | ToUpperCase }}, _AUTH_SVC_{{ .MethodName | ToUpperCase }} , _AUTH_SVC_CI_{{ .MethodName | ToUpperCase }})
		if err != nil {
			return nil, err
		}
		for key, value := range webHeaders {
			whc.Add(key, value)
		}
	}
	return whc, nil
}

func init() {
	_reqMapper{{ .MethodName | ToPascalCase }} = {{ .RequestMapper }}
	_resMapper{{ .MethodName | ToPascalCase }} = {{ .ResponseMapper }}
	_url{{ .MethodName | ToPascalCase }} = http.NewUrlTemplate(_URL_{{ .MethodName | ToUpperCase }})
	service.Register(
		service.New(
			_CN_{{ .MethodName | ToUpperCase }},
			_NS_{{ .MethodName | ToUpperCase }},
			_QUEUE_{{ .MethodName | ToUpperCase }},
			handler{{ .MethodName | ToPascalCase}},
			func() *Request{{ .MethodName | ToPascalCase }} {
				return &Request{{ .MethodName | ToPascalCase }}{}
			},
			func() *Response{{ .MethodName | ToPascalCase }} {
				return &Response{{ .MethodName | ToPascalCase }}{}
			},
			service.WithCache(time.Hour),
		),
	)
}
